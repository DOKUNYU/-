# Read me 1.0
## 啊对对队  电控软件技术文档

## 1实现目标
1. 使用遥控操控底盘的电机运动与炮台的舵机运动
2. 控制底盘进行前进后退、旋转平移等操作
3.	控制炮台在左右一百八十度及上下九十度范围内进行旋转
4.	使用编码电机控制拨轮的转动实现子弹的单发和连发模式
5.	使用遥控对符文相对位置进行标定，再使用电脑与串口通讯通信实现电脑控制定位击打符文
6.	利用视觉实现移动靶的击打

## 2使用材料
- Arduino MEGA
- TB6612驱动模块
- PCB
- 编码电机
- 遥控器
- 一位机
- 接收机 
- zigbee
- 舵机
- 摩擦轮
- 拨轮

## 3编译
使用Arduino进行编译，开发板选择Arduino Mega or Mega 2560
使用了 ppm.h库和Servo.h库

## 4技术点讲解
- **1.远程通讯**
  - 遥控器选用WFLY的ET07，工作在2.4GHz波段，自动跳频以防止互相干扰，接收器将收到的信号解码后，以PPM协议输出。每个通道信号脉宽0~2ms，变化范围为1~2ms之间。1帧PPM信号长度为20ms，理论上最多可以有10个通道，但是同步脉冲也需要时间，ET07遥控器支持最多8个通道。
  ![](https://s3.bmp.ovh/imgs/2022/05/13/9fd9c34aaf710248.png)
  - 程序中，直接调用PPM.h的库函数，信号线连接在D13口，使用外部中断1，在脉冲的上升沿及下降沿均触发中断，并在中断处理函数中判断触发方式（上升沿或下降沿），然后分别记录进入中断的时刻,然后下降沿时刻减去上升沿时刻，即可得到一个脉冲的宽度，从而解析出每个通道的数值，再加以一定处理（中立点换算、死区设置、拨杆开关状态量转换），然后分别写入throttle,roll,pitch,yaw,sb,sc,sd,v1总计8个变量
- **2.电机驱动**
  - 电机正负极连接至PCB，PCB上板载5v、12v供电，安装两块TB6612，同时将信号线引出连接至arduino。
  ![](https://s3.bmp.ovh/imgs/2022/05/13/8c5310ee93f72fcf.png)
- **3.多模式控制**
  - 使用遥控器上的sa，sb双按钮配合，sa有-1（下拨）和1（上拨）两种状态，sb有-1（上拨），0（中间），1（下拨）三种状态，组合成五种状态，分别为底盘控制模式，云台和发射控制模式下的半自动模式与全自动模式，符文模式下的标定模式和手控模式。
    - 底盘控制模式(`mecanum()`)：控制底盘的运动
    - 半自动模式(`servocontrol()`及`semiAuto()`)：
    - 全自动模式(`servocontrol()`及`fullAuto()`)：
    - 标定模式(`address()`)：手动标定符文的三个x位置和三个y位置
    - 手控模式(`ComuputerControl()`)：使用电脑数字键盘控制炮台击打符文
   ![五种模式图解](https://s3.bmp.ovh/imgs/2022/05/13/e7458e8d4c8e13c7.png)
- **4.底盘控制**
  - 使用了麦克纳姆轮的控制算法，实现了小车的前进后退、左右转弯、平移、原地旋转等运动模式。以roll（右侧摇杆左右），pitch（左侧摇杆上下），yaw（左侧摇杆左右，即旋转）作为输入，电机转动速率作为输出。
- **5.编码电机控制拨轮角度**
  - 马达轴上安装一增量式霍尔编码器，分为AB两相。A相连接至D2端口，即外部中断0，通过跳变触发中断，并在外部中断服务函数中，通过B相的高低电平确定正反转。由此不断累积，获取编码器所反馈的电机轴位置信息，即程序中的Pisition变量。
- **6.云台控制和发射控制模式**
  -  使用了一个`servocontrol()`的函数控制炮台舵机(upper与bottom)，pitch（左侧摇杆前后）和roll（右侧摇杆左右）参数作为输入，将摇杆移动距离作为舵机位移差值按比例输入，输出舵机角度。
  -  驱动两个摩擦轮(left和right)起旋，然后进入全自动与半自动模式。
  - **半自动模式**：使用`semiAuto()`函数作为半自动模式控制拨轮。当sd按钮拨下后，电机此时位置设为0位置， 目标位置设为46个单位，使用`Position_PID()`中的PID算法计算并返回电机应设置的PWM，最后使用`SetPWM()`函数驱动编码电机转动并拨动一个弹丸进入炮筒。
  - **全自动模式**：使用`fullAuto()`函数作为全自动模式控制拨轮。Sd按钮拨下后，`SetPWM()`函数使编码电机维持转动并持续将弹丸推入炮筒，直到sd按钮停止拨下动作使编码电机停止转动。
- **7.符文模式**
  - **标定模式**：使用一个`address()`函数对xy位置进行标定。当小车来到炮台前指定位置时，操作手目测激光落点，控制炮台指向指定的符文位置并按下sd按钮依次进行标定。将九个坐标对应数字键盘上的九个数字与位置，x坐标从左到右分成addressx[1]，addressx[2] ，addressx[3]，y坐标从上到下分成addressy[1]，addressy[2] ，addressy[3]，如下图坐标图所示。默认的标定顺序为7-8-9-6-3。使用一个switch函数分别判断与储存对应的坐标值。
![](https://s3.bmp.ovh/imgs/2022/05/13/59d9959d135f572f.png)
  - **手控模式**：标定完成后操作手观察三块亮起的符文屏幕，在电脑端使用串口助手和zigbee发送对应的三个符文板的编号以及校验码，arduino mega通过`ComputerControl()`函数接收zigbee收到的数据并校验。校验的方式是计算校验码是否为前面三位编号之和，若不正确则不进行发射；若正确则按照编号顺序依次击打对
- **8.视觉**
  - 接收从openMV传输的坐标数据，使用和校验方法检验接收的数据的可用性，并且转化为相应坐标的位移差并输入给`servocontrol()`函数控制炮筒指向目标位置，使用`fullAuto()`函数控制拨轮进弹，击打移动靶。
